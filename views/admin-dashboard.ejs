<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - AutoRent</title>
  <style>
    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page-header p {
      color: #7f8c8d;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .stat-icon.users {
      background: #e3f2fd;
      color: #2196f3;
    }

    .stat-icon.cars {
      background: #fff3e0;
      color: #ff9800;
    }

    .stat-icon.bookings {
      background: #e8f5e9;
      color: #4caf50;
    }

    .stat-icon.revenue {
      background: #fce4ec;
      color: #e91e63;
    }

    .stat-info h3 {
      font-size: 32px;
      margin-bottom: 5px;
      color: #2c3e50;
    }

    .stat-info p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .chart-section {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .chart-section h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }

    .recent-activity {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .recent-activity h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }

    .activity-item {
      padding: 15px 0;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3498db;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .activity-info {
      flex: 1;
    }

    .activity-info strong {
      color: #2c3e50;
    }

    .activity-info p {
      color: #7f8c8d;
      font-size: 13px;
      margin-top: 3px;
    }

    .activity-time {
      color: #95a5a6;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<%- include('layout', { body: '' }) %>

<div class="page-header">
  <h1>‚öôÔ∏è Admin Dashboard</h1>
  <p>Overview of system statistics and activities</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon users">üë•</div>
    <div class="stat-info">
      <h3 id="total-users">-</h3>
      <p>Total Users</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon cars">üöó</div>
    <div class="stat-info">
      <h3 id="total-cars">-</h3>
      <p>Total Cars</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon bookings">üìÖ</div>
    <div class="stat-info">
      <h3 id="total-bookings">-</h3>
      <p>Total Bookings</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon revenue">üí∞</div>
    <div class="stat-info">
      <h3 id="total-revenue">$-</h3>
      <p>Total Revenue</p>
    </div>
  </div>
</div>

<!-- Chart Section -->
<div class="chart-section">
  <h2>üìä Booking Statistics</h2>
  <div id="bookings-by-status">
    <p class="loading">‚è≥ Loading statistics...</p>
  </div>
</div>

<!-- Recent Activity -->
<div class="recent-activity">
  <h2>üìã Recent Activity</h2>
  
  <!-- Loading state -->
  <div id="activity-loading" class="loading">
    ‚è≥ Loading recent activity...
  </div>
  
  <!-- Activity container -->
  <div id="activity-container"></div>
  
  <!-- Empty state -->
  <div id="activity-empty" style="display: none;" class="loading">
    No recent activity to display
  </div>
</div>

<script>
  // Fetch dashboard data from API
  fetch('/api/v1/admin/bookings/summary')
    .then(response => {
      if (!response.ok) {
        throw new Error('API request failed with status ' + response.status);
      }
      return response.json();
    })
    .then(result => {
      if (result.success) {
        const data = result.data;
        
        // ===== UPDATE STATS CARDS =====
        
        // Total Users (API kh√¥ng c√≥, set 0 ho·∫∑c fetch ri√™ng)
        document.getElementById('total-users').textContent = data.totalUsers || '0';
        
        // Total Cars (API kh√¥ng c√≥, set 0 ho·∫∑c fetch ri√™ng)
        document.getElementById('total-cars').textContent = data.totalCars || '0';
        
        // Total Bookings
        document.getElementById('total-bookings').textContent = data.totalBookings || '0';
        
        // Total Revenue (t√≠nh t·ª´ bookingsByStatus)
        let totalRevenue = 0;
        if (data.bookingsByStatus && Array.isArray(data.bookingsByStatus)) {
          totalRevenue = data.bookingsByStatus.reduce((sum, item) => {
            return sum + (item.totalRevenue || 0);
          }, 0);
        }
        document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
        
        // ===== UPDATE BOOKINGS BY STATUS =====
        
        if (data.bookingsByStatus && data.bookingsByStatus.length > 0) {
          const statusHtml = data.bookingsByStatus.map(item => `
            <div style="padding: 10px; border-left: 4px solid #3498db; margin-bottom: 10px; background: #f8f9fa;">
              <strong>${item._id}</strong>: ${item.count} bookings | Revenue: $${item.totalRevenue}
            </div>
          `).join('');
          document.getElementById('bookings-by-status').innerHTML = statusHtml;
        } else {
          document.getElementById('bookings-by-status').innerHTML = 
            '<p style="color: #7f8c8d; text-align: center; padding: 40px;">No booking statistics available</p>';
        }
        
        // ===== UPDATE RECENT ACTIVITY =====
        
        document.getElementById('activity-loading').style.display = 'none';
        
        if (data.recentBookings && data.recentBookings.length > 0) {
          const activityHtml = data.recentBookings.slice(0, 5).map(booking => {
            const daysAgo = Math.floor((new Date() - new Date(booking.createdAt)) / (1000 * 60 * 60 * 24));
            
            return `
              <div class="activity-item">
                <div class="activity-icon">üîî</div>
                <div class="activity-info">
                  <strong>${booking.userId?.name || 'User'}</strong> booked 
                  <strong>${booking.carId?.brand || 'N/A'} ${booking.carId?.model || ''}</strong>
                  <p>From ${new Date(booking.startDate).toLocaleDateString()} to ${new Date(booking.endDate).toLocaleDateString()}</p>
                </div>
                <div class="activity-time">
                  ${daysAgo}d ago
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('activity-container').innerHTML = activityHtml;
        } else {
          document.getElementById('activity-empty').style.display = 'block';
        }
      } else {
        throw new Error('API returned success: false');
      }
    })
    .catch(error => {
      console.error('Error loading dashboard:', error);
      
      // Show error in activity section
      document.getElementById('activity-loading').innerHTML = 
        '<span style="color: #e74c3c;">‚ùå Error loading data: ' + error.message + '</span>';
      
      // Show placeholder values in stats
      document.getElementById('total-users').textContent = '0';
      document.getElementById('total-cars').textContent = '0';
      document.getElementById('total-bookings').textContent = '0';
      document.getElementById('total-revenue').textContent = '$0';
      
      // Show error in chart
      document.getElementById('bookings-by-status').innerHTML = 
        '<p style="color: #e74c3c; text-align: center; padding: 40px;">Failed to load statistics</p>';
    });
</script>

</body>
</html>